DESCRIPTION >
    Store OpenAI moderation results with cf_ray for joining with main events table

SCHEMA >
    `id` String `json:$.id`,
    -- NOTE: Current field mappings may not align perfectly with actual OpenAI/Azure moderation API response structure
    -- The API returns nested content_filter_results with filtered/severity/detected flags per category
    -- Consider updating JSON paths and field structure if ingestion issues occur
    `timestamp` DateTime `json:$.timestamp` DEFAULT now(),
    `choice_index` UInt8 `json:$.choice_index` DEFAULT 0,

    -- Core moderation categories with both severity and filtered status
    `hate_severity` LowCardinality(String) `json:$.hate.severity` DEFAULT 'safe',
    `hate_filtered` Bool `json:$.hate.filtered` DEFAULT false,
    `self_harm_severity` LowCardinality(String) `json:$.self_harm.severity` DEFAULT 'safe',
    `self_harm_filtered` Bool `json:$.self_harm.filtered` DEFAULT false,
    `sexual_severity` LowCardinality(String) `json:$.sexual.severity` DEFAULT 'safe',
    `sexual_filtered` Bool `json:$.sexual.filtered` DEFAULT false,
    `violence_severity` LowCardinality(String) `json:$.violence.severity` DEFAULT 'safe',
    `violence_filtered` Bool `json:$.violence.filtered` DEFAULT false,

    -- Protected material detection
    `protected_material_code_detected` Bool `json:$.protected_material_code.detected` DEFAULT false,
    `protected_material_code_filtered` Bool `json:$.protected_material_code.filtered` DEFAULT false,
    `protected_material_code_url` Nullable(String) `json:$.protected_material_code.citation.URL` DEFAULT NULL,
    `protected_material_code_license` Nullable(String) `json:$.protected_material_code.citation.license` DEFAULT NULL,
    `protected_material_text_detected` Bool `json:$.protected_material_text.detected` DEFAULT false,
    `protected_material_text_filtered` Bool `json:$.protected_material_text.filtered` DEFAULT false,

    -- Additional detection categories
    `jailbreak_detected` Bool `json:$.jailbreak.detected` DEFAULT false,
    `jailbreak_filtered` Bool `json:$.jailbreak.filtered` DEFAULT false,
    `profanity_detected` Bool `json:$.profanity.detected` DEFAULT false,
    `profanity_filtered` Bool `json:$.profanity.filtered` DEFAULT false

ENGINE "MergeTree" 
ENGINE_PARTITION_KEY "toYYYYMM(timestamp)"
ENGINE_SORTING_KEY "timestamp, id"
ENGINE_PRIMARY_KEY "timestamp, id"

FORWARD_QUERY > 
  SELECT id, defaultValueOfTypeName('DateTime') AS timestamp, defaultValueOfTypeName('UInt8') AS choice_index, hate_severity, defaultValueOfTypeName('Bool') AS hate_filtered, self_harm_severity, defaultValueOfTypeName('Bool') AS self_harm_filtered, sexual_severity, defaultValueOfTypeName('Bool') AS sexual_filtered, violence_severity, defaultValueOfTypeName('Bool') AS violence_filtered, protected_material_code_detected, defaultValueOfTypeName('Bool') AS protected_material_code_filtered, defaultValueOfTypeName('Nullable(String)') AS protected_material_code_url, defaultValueOfTypeName('Nullable(String)') AS protected_material_code_license, protected_material_text_detected, defaultValueOfTypeName('Bool') AS protected_material_text_filtered, defaultValueOfTypeName('Bool') AS jailbreak_detected, defaultValueOfTypeName('Bool') AS jailbreak_filtered, defaultValueOfTypeName('Bool') AS profanity_detected, defaultValueOfTypeName('Bool') AS profanity_filtered


