TOKEN read_pipes READ

DESCRIPTION >
    Get exactly 7 daily cost values for the last 7 days from request time for a specific user.
    Returns one row per day with cost data, filling gaps with zeros for days with no activity.

NODE daily_cost_7d_node
SQL >
    %
    WITH day_series AS (
        SELECT 
            toStartOfDay(now() - INTERVAL number DAY) as day_start
        FROM numbers(7)
    ),
    user_daily_costs AS (
        SELECT
            toStartOfDay(timestamp) as day_start,
            sum(cost) as total_cost
        FROM llm_events
        WHERE 1=1
            {% if defined(user) %}
            AND user = {{String(user, 'default_user')}}
            {% else %}
            AND user = 'default_user'
            {% end %}
            AND timestamp >= now() - INTERVAL 7 DAY
            AND timestamp <= now()
        GROUP BY day_start
    )
    SELECT 
        ds.day_start as day,
        COALESCE(udc.total_cost, 0) as total_cost
    FROM day_series ds
    LEFT JOIN user_daily_costs udc ON ds.day_start = udc.day_start
    ORDER BY day ASC

TYPE endpoint
