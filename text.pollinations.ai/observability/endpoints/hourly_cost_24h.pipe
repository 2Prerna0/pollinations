TOKEN read_pipes READ

DESCRIPTION >
    Get exactly 24 hourly cost values for the last 24 hours from request time for a specific user.
    Returns one row per hour with cost data, filling gaps with zeros for hours with no activity.

NODE hourly_cost_24h_node
SQL >
    %
    WITH hour_series AS (
        SELECT 
            toStartOfHour(now() - INTERVAL number HOUR) as hour_start
        FROM numbers(24)
    ),
    user_hourly_costs AS (
        SELECT
            toStartOfHour(timestamp) as hour_start,
            sum(cost) as total_cost
        FROM llm_events
        WHERE 1=1
            {% if defined(user) %}
            AND user = {{String(user, 'default_user')}}
            {% else %}
            AND user = 'default_user'
            {% end %}
            AND timestamp >= now() - INTERVAL 24 HOUR
            AND timestamp <= now()
        GROUP BY hour_start
    )
    SELECT 
        hs.hour_start as hour,
        COALESCE(uhc.total_cost, 0) as total_cost
    FROM hour_series hs
    LEFT JOIN user_hourly_costs uhc ON hs.hour_start = uhc.hour_start
    ORDER BY hour ASC

TYPE endpoint
